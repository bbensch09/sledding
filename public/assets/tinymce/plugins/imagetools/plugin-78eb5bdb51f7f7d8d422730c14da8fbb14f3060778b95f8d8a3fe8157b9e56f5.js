/**
 * Copyright (c) Tiny Technologies, Inc. All rights reserved.
 * Licensed under the LGPL or a commercial license.
 * For LGPL see License.txt in the project root for license information.
 * For commercial licenses see https://www.tiny.cloud/
 *
 * Version: 5.5.1 (2020-10-01)
 */
!function(){"use strict";function t(t,e){return r(document.createElement("canvas"),t,e)}function e(e){var r=t(e.width,e.height);return n(r).drawImage(e,0,0),r}function n(t){return t.getContext("2d")}function r(t,e,n){return t.width=e,t.height=n,t}function o(t,e){return function(){return t.apply(e,arguments)}}function i(t){var e=this;null!==this._state?x(function(){var n,r=e._state?t.onFulfilled:t.onRejected;if(null!==r){try{n=r(e._value)}catch(U){return void t.reject(U)}t.resolve(n)}else(e._state?t.resolve:t.reject)(e._value)}):this._deferreds.push(t)}function u(t){try{if(t===this)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var e=t.then;if("function"==typeof e)return void f(o(e,t),o(u,this),o(a,this))}this._state=!0,this._value=t,c.call(this)}catch(U){a.call(this,U)}}function a(t){this._state=!1,this._value=t,c.call(this)}function c(){for(var t=0,e=this._deferreds;t<e.length;t++){var n=e[t];i.call(this,n)}this._deferreds=[]}function s(t,e,n,r){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof e?e:null,this.resolve=n,this.reject=r}function f(t,e,n){var r=!1;try{t(function(t){r||(r=!0,e(t))},function(t){r||(r=!0,n(t))})}catch(C){if(r)return;r=!0,n(C)}}function l(t){var e,n=t.src;return 0===n.indexOf("data:")?m(n):(e=n,new $(function(t,n){var r=new XMLHttpRequest;r.open("GET",e,!0),r.responseType="blob",r.onload=function(){200===this.status&&t(this.response)},r.onerror=function(){var t,e=this;n(0===this.status?((t=new Error("No access to download image")).code=18,t.name="SecurityError",t):new Error("Error "+e.status+" downloading image"))},r.send()}))}function d(t){return new $(function(e,n){function r(){a(),e(u)}function o(){a(),n("Unable to load data of type "+t.type+": "+i)}var i=URL.createObjectURL(t),u=new Image,a=function(){u.removeEventListener("load",r),u.removeEventListener("error",o)};u.addEventListener("load",r),u.addEventListener("error",o),u.src=i,u.complete&&r()})}function m(t){return new $(function(e,n){(function(t){var e=t.split(","),n=/data:([^;]+)/.exec(e[0]);if(!n)return H.none();for(var r=n[1],o=e[1],i=atob(o),u=i.length,a=Math.ceil(u/1024),c=new Array(a),s=0;s<a;++s){for(var f=1024*s,l=Math.min(1024+f,u),d=new Array(l-f),m=f,h=0;m<l;++h,++m)d[h]=i[m].charCodeAt(0);c[s]=new Uint8Array(d)}return H.some(new Blob(c,{type:r}))})(t).fold(function(){n("uri is not base64: "+t)},e)})}function h(t,e,n){return e=e||"image/png",z(HTMLCanvasElement.prototype.toBlob)?new $(function(r,o){t.toBlob(function(t){t?r(t):o()},e,n)}):m(t.toDataURL(e,n))}function g(e){return d(e).then(function(e){var r;r=e,URL.revokeObjectURL(r.src);var o,i,u=t((i=e).naturalWidth||i.width,(o=e).naturalHeight||o.height);return n(u).drawImage(e,0,0),u})}function p(t,n,r){function o(e,n){return t.then(function(t){return o=n,r=(r=e)||"image/png",t.toDataURL(r,o);var r,o})}var i=n.type;return{getType:S(i),toBlob:function(){return $.resolve(n)},toDataURL:S(r),toBase64:function(){return r.split(",")[1]},toAdjustedBlob:function(e,n){return t.then(function(t){return h(t,e,n)})},toAdjustedDataURL:o,toAdjustedBase64:function(t,e){return o(t,e).then(function(t){return t.split(",")[1]})},toCanvas:function(){return t.then(e)}}}function v(t){return e=t,new $(function(t){var n=new FileReader;n.onloadend=function(){t(n.result)},n.readAsDataURL(e)}).then(function(e){return p(g(t),t,e)});var e}function y(t,e){return h(t,e).then(function(e){return p($.resolve(t),e,t.toDataURL())})}function w(e,o){return e.toCanvas().then(function(i){return function(e,o,i){var u=t(e.width,e.height),a=n(u),c=0,s=0;return 90!==(i=i<0?360+i:i)&&270!==i||r(u,u.height,u.width),90!==i&&180!==i||(c=u.width),270!==i&&180!==i||(s=u.height),a.translate(c,s),a.rotate(i*Math.PI/180),a.drawImage(e,0,0),y(u,o)}(i,e.getType(),o)})}function b(e,r){return e.toCanvas().then(function(o){return function(e,r,o){var i=t(e.width,e.height),u=n(i);return"v"===o?(u.scale(1,-1),u.drawImage(e,0,-i.height)):(u.scale(-1,1),u.drawImage(e,-i.width,0)),y(i,r)}(o,e.getType(),r)})}function I(t){function e(t){return/^[0-9\.]+px$/.test(t)}var n,r;return n=t.style.width,r=t.style.height,n||r?e(n)&&e(r)?{w:parseInt(n,10),h:parseInt(r,10)}:null:(n=t.width,r=t.height,n&&r?{w:parseInt(n,10),h:parseInt(r,10)}:null)}function T(t){return{w:t.naturalWidth,h:t.naturalHeight}}var _,R,U,A,E,j,x,L,k=function(t){var e=t;return{get:function(){return e},set:function(t){e=t}}},C=tinymce.util.Tools.resolve("tinymce.PluginManager"),O=tinymce.util.Tools.resolve("tinymce.util.Tools"),P=function(){},S=function(t){return function(){return t}},M=S(!1),B=S(!0),N=function(){return D},D=(_=function(t){return t.isNone()},{fold:function(t){return t()},is:M,isSome:M,isNone:B,getOr:U=function(t){return t},getOrThunk:R=function(t){return t()},getOrDie:function(t){throw new Error(t||"error: getOrDie called on none.")},getOrNull:S(null),getOrUndefined:S(undefined),or:U,orThunk:R,map:N,each:P,bind:N,exists:M,forall:B,filter:N,equals:_,equals_:_,toArray:function(){return[]},toString:S("none()")}),F=function(t){var e=S(t),n=function(){return o},r=function(e){return e(t)},o={fold:function(e,n){return n(t)},is:function(e){return t===e},isSome:B,isNone:M,getOr:e,getOrThunk:e,getOrDie:e,getOrNull:e,getOrUndefined:e,or:n,orThunk:n,map:function(e){return F(e(t))},each:function(e){e(t)},bind:r,exists:r,forall:r,filter:function(e){return e(t)?o:D},toArray:function(){return[t]},toString:function(){return"some("+t+")"},equals:function(e){return e.is(t)},equals_:function(e,n){return e.fold(M,function(e){return n(t,e)})}};return o},H={some:F,none:N,from:function(t){return null===t||t===undefined?D:F(t)}},q=function(t){return!(null===(e=t)||e===undefined);var e},z=(A="function",function(t){return typeof t===A}),$=window.Promise?window.Promise:(E=function(t){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._state=null,this._value=null,this._deferreds=[],f(t,o(u,this),o(a,this))},j=window,x=E.immediateFn||"function"==typeof j.setImmediate&&j.setImmediate||function(t){setTimeout(t,1)},L=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},E.prototype["catch"]=function(t){return this.then(null,t)},E.prototype.then=function(t,e){var n=this;return new E(function(r,o){i.call(n,new s(t,e,r,o))})},E.all=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=Array.prototype.slice.call(1===t.length&&L(t[0])?t[0]:t);return new E(function(t,e){if(0===n.length)return t([]);for(var r=n.length,o=0;o<n.length;o++)!function i(o,u){try{if(u&&("object"==typeof u||"function"==typeof u)){var a=u.then;if("function"==typeof a)return void a.call(u,function(t){i(o,t)},e)}n[o]=u,0==--r&&t(n)}catch(A){e(A)}}(o,n[o])})},E.resolve=function(t){return t&&"object"==typeof t&&t.constructor===E?t:new E(function(e){e(t)})},E.reject=function(t){return new E(function(e,n){n(t)})},E.race=function(t){return new E(function(e,n){for(var r=0,o=t;r<o.length;r++)o[r].then(e,n)})},E),G=d,J=l,K=function(t,e){return function(t,e,n){for(var r=0,o=t.length;r<o;r++){var i=t[r];if(e(i,r))return H.some(i);if(n(i,r))break}return H.none()}(t,e,M)},V=b,W=w,X=Object.keys,Q=function(t,e,n){return void 0===n&&(n=!1),new $(function(r){var o=new XMLHttpRequest;o.onreadystatechange=function(){4===o.readyState&&r({status:o.status,blob:o.response})},o.open("GET",t,!0),o.withCredentials=n,function(t,e){for(var n=X(t),r=0,o=n.length;r<o;r++){var i=n[r];e(t[i],i)}}(e,function(t,e){o.setRequestHeader(e,t)}),o.responseType="blob",o.send()})},Y=[{code:404,message:"Could not find Image Proxy"},{code:403,message:"Rejected request"},{code:0,message:"Incorrect Image Proxy URL"}],Z=[{type:"not_found",message:"Failed to load image."},{type:"key_missing",message:"The request did not include an api key."},{type:"key_not_found",message:"The provided api key could not be found."},{type:"domain_not_trusted",message:"The api key is not valid for the request origins."}],tt=function(t,e){var n,r,o=(n=function(t,e){return q(t)?t[e]:undefined},r=t,function(t,e){for(var n=0,r=t.length;n<r;n++)e(t[n],n)}(e,function(t){r=n(r,t)}),r);return H.from(o)},et=function(t){var e,n=(e=t,"ImageProxy HTTP error: "+K(Y,function(t){return e===t.code}).fold(S("Unknown ImageProxy error"),function(t){return t.message}));return $.reject(n)},nt=function(t){return K(Z,function(e){return e.type===t}).fold(S("Unknown service error"),function(t){return t.message})},rt=function(t){return"ImageProxy Service error: "+function(t){try{return H.some(JSON.parse(t))}catch(R){return H.none()}}(t).bind(function(t){return tt(t,["error","type"]).map(nt)}).getOr("Invalid JSON in service error message")},ot=function(t){return e=t,new $(function(t,n){var r=new FileReader;r.onload=function(){t(r.result)},r.onerror=function(t){n(t)},r.readAsText(e)}).then(function(t){var e=rt(t);return $.reject(e)});var e},it=function(t){return t<200||300<=t},ut=function(t,e){var n,r,o,i={"Content-Type":"application/json;charset=UTF-8","tiny-api-key":e};return Q((r=e,o=-1===(n=t).indexOf("?")?"?":"&",/[?&]apiKey=/.test(n)?n:n+o+"apiKey="+encodeURIComponent(r)),i).then(function(t){return it(t.status)?(r=e=t.status,"application/json"!==(null==(o=n=t.blob)?void 0:o.type)||400!==r&&403!==r&&404!==r&&500!==r?et(e):ot(n)):$.resolve(t.blob);var e,n,r,o})},at=function(t,e,n){return void 0===n&&(n=!1),e?ut(t,e):Q(t,{},n).then(function(t){return it(t.status)?et(t.status):$.resolve(t.blob)})},ct=v,st=function(t){if(null===t||t===undefined)throw new Error("Node cannot be null or undefined");return{dom:t}},ft={fromHtml:function(t,e){var n=(e||document).createElement("div");if(n.innerHTML=t,!n.hasChildNodes()||1<n.childNodes.length)throw console.error("HTML does not have a single root node",t),new Error("HTML must have a single root node");return st(n.childNodes[0])},fromTag:function(t,e){var n=(e||document).createElement(t);return st(n)},fromText:function(t,e){var n=(e||document).createTextNode(t);return st(n)},fromDom:st,fromPoint:function(t,e,n){return H.from(t.dom.elementFromPoint(e,n)).map(st)}},lt=("undefined"!=typeof window||Function("return this;")(),function(t,e){return n=function(t){return function(t,e){var n=t.dom;if(1!==n.nodeType)return!1;var r=n;if(r.matches!==undefined)return r.matches(e);if(r.msMatchesSelector!==undefined)return r.msMatchesSelector(e);if(r.webkitMatchesSelector!==undefined)return r.webkitMatchesSelector(e);if(r.mozMatchesSelector!==undefined)return r.mozMatchesSelector(e);throw new Error("Browser lacks native selectors")}(t,e)},K(t.dom.childNodes,function(t){return n(ft.fromDom(t))}).map(ft.fromDom);var n}),dt=tinymce.util.Tools.resolve("tinymce.util.Delay"),mt=tinymce.util.Tools.resolve("tinymce.util.Promise"),ht=tinymce.util.Tools.resolve("tinymce.util.URI"),gt=function(t){return t.getParam("imagetools_proxy")},pt=0,vt=function(t){return lt(ft.fromDom(t),"img")},yt=function(t,e){return t.dom.is(e,"figure")},wt=function(t,e){var n=function(e){return n=e,t.dom.is(n,"img:not([data-mce-object],[data-mce-placeholder])")&&(Tt(t,e)||_t(t,e)||gt(t));var n};return yt(t,e)?vt(e).map(function(t){return n(t.dom)?H.some(t.dom):H.none()}):n(e)?H.some(e):H.none()},bt=function(t,e){t.notificationManager.open({text:e,type:"error"})},It=function(t){var e=t.selection.getNode();return yt(t,e)?vt(e):H.some(ft.fromDom(e))},Tt=function(t,e){var n=e.src;return 0===n.indexOf("data:")||0===n.indexOf("blob:")||new ht(n).host===t.documentBaseURI.host},_t=function(t,e){return-1!==O.inArray(t.getParam("imagetools_cors_hosts",[],"string[]"),new ht(e.src).host)},Rt=function(t,e){if(_t(t,e))return at(e.src,null,(n=t,r=e,-1!==O.inArray(n.getParam("imagetools_credentials_hosts",[],"string[]"),new ht(r.src).host)));var n,r,o;if(Tt(t,e))return J(e);var i=gt(t),u=i+(-1===i.indexOf("?")?"?":"&")+"url="+encodeURIComponent(e.src),a=(o=t).getParam("api_key",o.getParam("imagetools_api_key","","string"),"string");return at(u,a,!1)},Ut=function(t,e){return n=t,H.from(n.getParam("imagetools_fetch_image",null,"function")).fold(function(){return Rt(t,e)},function(t){return t(e)});var n},At=function(t,e){var n=t.editorUpload.blobCache.getByUri(e.src);return n?mt.resolve(n.blob()):Ut(t,e)},Et=function(t){dt.clearTimeout(t.get())},jt=function(t,e,n,r,o,i){return e.toBlob().then(function(u){var a,c,s,f,l=t.editorUpload.blobCache,d=o.src;return t.getParam("images_reuse_filename",!1,"boolean")&&(a=(c=l.getByUri(d))?(d=c.uri(),c.name()):(s=t,(f=d.match(/\/([^\/\?]+)?\.(?:jpeg|jpg|png|gif)(?:\?|$)/i))?s.dom.encode(f[1]):null)),c=l.create({id:"imagetools"+pt++,blob:u,base64:e.toBase64(),uri:d,name:a}),l.add(c),t.undoManager.transact(function(){t.$(o).on("load",function e(){var i,u,a;t.$(o).off("load",e),t.nodeChanged(),n?t.editorUpload.uploadImagesAuto():(Et(r),i=t,u=r,a=dt.setEditorTimeout(i,function(){i.editorUpload.uploadImagesAuto()},i.getParam("images_upload_timeout",3e4,"number")),u.set(a))}),i&&t.$(o).attr({width:i.w,height:i.h}),t.$(o).attr({src:c.blobUri()}).removeAttr("data-mce-src")}),c})},xt=function(t,e,n,r){return function(){return It(t).fold(function(){bt(t,"Could not find selected image")},function(o){return t._scanForImages().then(function(){return At(t,o.dom)}).then(ct).then(n).then(function(n){return jt(t,n,!1,e,o.dom,r)},function(e){bt(t,e)})})}},Lt=function(t,e,n){return function(){var r=It(t).fold(function(){return null},function(t){var e=I(t.dom);return e?{w:e.h,h:e.w}:null});return xt(t,e,function(t){return W(t,n)},r)()}},kt=function(t,e,n){return function(){return xt(t,e,function(t){return V(t,n)})()}},Ct=function(t,e,n,r,o){return G(o).then(function(t){var e,i,u,a,c=T(t);return r.w===c.w&&r.h===c.h||I(n)&&(e=n,(i=c)&&(u=e.style.width,a=e.style.height,(u||a)&&(e.style.width=i.w+"px",e.style.height=i.h+"px",e.removeAttribute("data-mce-style")),u=e.width,a=e.height,(u||a)&&(e.setAttribute("width",i.w),e.setAttribute("height",i.h)))),URL.revokeObjectURL(t.src),o}).then(ct).then(function(r){return jt(t,r,!0,e,n)},function(){})},Ot=function(t,e){return function(){var n=It(t),r=n.map(function(t){return T(t.dom)});It(t).each(function(o){wt(t,o.dom).each(function(){At(t,o.dom).then(function(o){var i,u={blob:i=o,url:URL.createObjectURL(i)};t.windowManager.open({title:"Edit Image",size:"large",body:{type:"panel",items:[{type:"imagetools",name:"imagetools",label:"Edit Image",currentState:u}]},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0,disabled:!0}],onSubmit:function(o){var i=o.getData().imagetools.blob;n.each(function(n){r.each(function(r){Ct(t,e,n.dom,r,i)})}),o.close()},onCancel:function(){},onAction:function(t,e){switch(e.name){case"save-state":e.value?t.enable("save"):t.disable("save");break;case"disable":t.disable("save"),t.disable("cancel");break;case"enable":t.enable("cancel")}}})})})})}};C.add("imagetools",function(t){var e,n,r,o,i,u,a,c,s=k(0),f=k(null);e=t,n=s,O.each({mceImageRotateLeft:Lt(e,n,-90),mceImageRotateRight:Lt(e,n,90),mceImageFlipVertical:kt(e,n,"v"),mceImageFlipHorizontal:kt(e,n,"h"),mceEditImage:Ot(e,n)},function(t,n){e.addCommand(n,t)}),o=function(t){return function(){return r.execCommand(t)}},(r=t).ui.registry.addButton("rotateleft",{tooltip:"Rotate counterclockwise",icon:"rotate-left",onAction:o("mceImageRotateLeft")}),r.ui.registry.addButton("rotateright",{tooltip:"Rotate clockwise",icon:"rotate-right",onAction:o("mceImageRotateRight")}),r.ui.registry.addButton("flipv",{tooltip:"Flip vertically",icon:"flip-vertically",onAction:o("mceImageFlipVertical")}),r.ui.registry.addButton("fliph",{tooltip:"Flip horizontally",icon:"flip-horizontally",onAction:o("mceImageFlipHorizontal")}),r.ui.registry.addButton("editimage",{tooltip:"Edit image",icon:"edit-image",onAction:o("mceEditImage"),onSetup:function(t){var e=function(){It(r).each(function(e){var n=wt(r,e.dom).isNone();t.setDisabled(n)})};return r.on("NodeChange",e),function(){r.off("NodeChange",e)}}}),r.ui.registry.addButton("imageoptions",{tooltip:"Image options",icon:"image",onAction:o("mceImage")}),r.ui.registry.addContextMenu("imagetools",{update:function(t){return wt(r,t).fold(function(){return[]},function(){return[{text:"Edit image",icon:"edit-image",onAction:o("mceEditImage")}]})}}),(i=t).ui.registry.addContextToolbar("imagetools",{items:i.getParam("imagetools_toolbar","rotateleft rotateright flipv fliph editimage imageoptions"),predicate:function(t){return wt(i,t).isSome()},position:"node",scope:"node"}),a=s,c=f,(u=t).on("NodeChange",function(t){var e=c.get();e&&e.src!==t.element.src&&(Et(a),u.editorUpload.uploadImagesAuto(),c.set(null)),wt(u,t.element).each(c.set)})})}();